# Ansible Docker Deployment Project

This project provides automated deployment and cleanup of a WordPress stack (WordPress, MySQL, phpMyAdmin, and Nginx with SSL) using Ansible and Docker Compose. It also includes playbooks for provisioning an AWS EC2 instance and managing secrets securely with Ansible Vault.

## Features

- Automated provisioning of an EC2 instance on AWS (with security group and SSH key setup)
- Secure storage of sensitive variables (AWS credentials, WordPress admin password) using Ansible Vault
- Automated installation and configuration of Docker, Docker Compose, and required services
- SSL certificate generation for Nginx reverse proxy
- One-command deployment and cleanup of the entire stack

## Prerequisites

- An AWS account with a user that has the **AmazonEC2FullAccess** role
- A VPC and subnet set up in your AWS account (you will need their IDs)
- [Ansible](https://www.ansible.com/) and [Ansible Vault](https://docs.ansible.com/ansible/latest/user_guide/vault.html) installed locally
- [Docker](https://www.docker.com/) and [Docker Compose](https://docs.docker.com/compose/) (for local testing, optional)
- SSH key pair for EC2 access

## Secrets Management

Sensitive variables are stored using **Ansible Vault**. You must create a vault file (e.g., `group_vars/all/vault.yml`) containing:

```yaml
ec2_access_key: YOUR_AWS_ACCESS_KEY
ec2_secret_key: YOUR_AWS_SECRET_KEY
wordpress_password: YOUR_WORDPRESS_ADMIN_PASSWORD
```

Encrypt the file with:

```bash
ansible-vault encrypt group_vars/all/vault.yml
```

## Usage

### 1. Provision AWS EC2 Instance

Edit [`playbooks/provision_aws_ec2.yml`](playbooks/provision_aws_ec2.yml) and set the correct values for:
- `region`
- `image` (AMI ID)
- `subnet_id`
- `vpc_id`
- `key_name` and `key_path` (your SSH key)

Run the provisioning playbook:

```bash
ansible-playbook playbooks/provision_aws_ec2.yml --ask-vault-pass
```

This will:
- Create a security group
- Upload your SSH public key
- Launch an EC2 instance
- Write the instance details to `inventory.yml`

### 2. Configure Inventory

Check that `inventory.yml` was created and contains your EC2 instance details. Example:

```yaml
all:
  hosts:
    ec2_instance:
      ansible_host: <EC2_PUBLIC_IP>
      ansible_user: <ec2_user>
      ansible_ssh_private_key_file: <key_path>
```

### 3. Prepare Docker Secrets

Create the required secrets for the database:

```bash
mkdir -p docker-setup/secrets/
echo "your-db-password" > docker-setup/secrets/db_password.txt
echo "your-root-password" > docker-setup/secrets/db_root_password.txt
```

### 4. Deploy the Stack

To deploy WordPress, MySQL, phpMyAdmin, and Nginx with SSL:

```bash
ansible-playbook playbooks/site.yml --ask-vault-pass
```

- Use `--ask-become-pass` if not running as root.

### 5. Clean Up

To remove all containers, Docker, and related files from the remote host:

```bash
ansible-playbook playbooks/clean.yml --ask-vault-pass
```

- Use `--ask-become-pass` if not running as root.

### 6. Restart a Container

To restart a specific Docker container:

```bash
ansible-playbook playbooks/restart.yml -e "container_name=<container_name>" --ask-vault-pass
```

## Project Structure

```
.
├── ansible.cfg
├── inventory.yml                # Generated by provisioning playbook
├── playbooks/
│   ├── site.yml                # Main deployment playbook
│   ├── clean.yml               # Cleanup playbook
│   ├── restart.yml             # Restart container playbook
│   └── provision_aws_ec2.yml   # AWS EC2 provisioning playbook
├── docker-setup/
│   ├── compose.yml             # Docker Compose configuration
│   └── nginx.conf              # Nginx reverse proxy configuration
├── roles/
│   ├── cert_generation/        # SSL certificate generation
│   ├── docker_setup/           # Docker installation and deployment
│   └── env_cleaning/           # Environment cleanup
└── group_vars/
    └── all/
        └── vault.yml           # Encrypted secrets (with Ansible Vault)
```

## Technologies Used

- **Ansible**: Infrastructure automation
- **Ansible Vault**: Secure secrets management
- **Docker & Docker Compose**: Container orchestration
- **Nginx**: SSL reverse proxy
- **WordPress**: CMS
- **MySQL**: Database
- **phpMyAdmin**: DB management

## Notes

- Ensure your AWS user has the required permissions and that your VPC/subnet exist before running the provisioning playbook.
- All secrets (AWS keys, WordPress password) must be stored in the encrypted vault file.
- For troubleshooting, check the output of each playbook and the logs of the